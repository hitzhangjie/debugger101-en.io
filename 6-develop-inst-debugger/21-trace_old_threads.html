
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>6.21 Tracing Multi-threaded Programs 2 Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-md-toc/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="80-aslr.html" />
    
    
    <link rel="prev" href="20-trace_new_threads.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    1 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../2-preface/">
            
                <a href="../2-preface/">
            
                    
                    2 Preface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../3-terms/">
            
                <a href="../3-terms/">
            
                    
                    3 Common Terms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../4-basics/">
            
                <a href="../4-basics/">
            
                    
                    4 Software Debugging Basics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../4-basics/1-purposes.html">
            
                <a href="../4-basics/1-purposes.html">
            
                    
                    4.1 Debugging Purposes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../4-basics/2-dependencies.html">
            
                <a href="../4-basics/2-dependencies.html">
            
                    
                    4.2 Debugging Dependencies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../4-basics/3-countertactics.html">
            
                <a href="../4-basics/3-countertactics.html">
            
                    
                    4.3 Anti-Debugging Techniques
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../5-debugger-skeleton/">
            
                <a href="../5-debugger-skeleton/">
            
                    
                    5 Entering Debugger Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../5-debugger-skeleton/1-debugger_skeleton.html">
            
                <a href="../5-debugger-skeleton/1-debugger_skeleton.html">
            
                    
                    5.1 Debugger Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../5-debugger-skeleton/2-debugger_demo.html">
            
                <a href="../5-debugger-skeleton/2-debugger_demo.html">
            
                    
                    5.2 Debugger Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    6 Developing Go Instruction-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="1-process_start.html">
            
                <a href="1-process_start.html">
            
                    
                    6.1 Process Launch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="2-process_attach.html">
            
                <a href="2-process_attach.html">
            
                    
                    6.2 Process Attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="3-process_start_attach.html">
            
                <a href="3-process_start_attach.html">
            
                    
                    6.3 Launch & Attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="4-debug-session.html">
            
                <a href="4-debug-session.html">
            
                    
                    6.4 Debug Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="5-disassemble.html">
            
                <a href="5-disassemble.html">
            
                    
                    6.5 Disassembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="6-breakpoint.html">
            
                <a href="6-breakpoint.html">
            
                    
                    6.6 Adding Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="7-breakpoints.html">
            
                <a href="7-breakpoints.html">
            
                    
                    6.7 Listing Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="8-clear.html">
            
                <a href="8-clear.html">
            
                    
                    6.8 Removing Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="9-clearall.html">
            
                <a href="9-clearall.html">
            
                    
                    6.9 Clearing All Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="10-step.html">
            
                <a href="10-step.html">
            
                    
                    6.10 Stepping Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.11" data-path="11-continue.html">
            
                <a href="11-continue.html">
            
                    
                    6.11 Running to Breakpoint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.12" data-path="12-pmem.html">
            
                <a href="12-pmem.html">
            
                    
                    6.12 Printing Memory Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.13" data-path="13-pregs.html">
            
                <a href="13-pregs.html">
            
                    
                    6.13 Printing Register Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.14" data-path="14-set-mem.html">
            
                <a href="14-set-mem.html">
            
                    
                    6.14 Modifying Memory Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.15" data-path="15-set-regs.html">
            
                <a href="15-set-regs.html">
            
                    
                    6.15 Modifying Register Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.16" data-path="20-trace_new_threads.html">
            
                <a href="20-trace_new_threads.html">
            
                    
                    6.20 Tracing Multi-threaded Programs 1
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.17" data-path="21-trace_old_threads.html">
            
                <a href="21-trace_old_threads.html">
            
                    
                    6.21 Tracing Multi-threaded Programs 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.18" data-path="80-aslr.html">
            
                <a href="80-aslr.html">
            
                    
                    6.80 Understanding ASLR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.19" data-path="99-more.html">
            
                <a href="99-more.html">
            
                    
                    6.99 More...
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../7-headto-sym-debugger/">
            
                <a href="../7-headto-sym-debugger/">
            
                    
                    7 Advancing to Symbol-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../7-headto-sym-debugger/1-how-go-build-works.html">
            
                <a href="../7-headto-sym-debugger/1-how-go-build-works.html">
            
                    
                    7.1 Go Build Internals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../7-headto-sym-debugger/2-elf.html">
            
                <a href="../7-headto-sym-debugger/2-elf.html">
            
                    
                    7.2 Understanding ELF Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../7-headto-sym-debugger/3-syms.html">
            
                <a href="../7-headto-sym-debugger/3-syms.html">
            
                    
                    7.3 Symbols & Symbol Tables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../7-headto-sym-debugger/4-syms-resolve-reloc.html">
            
                <a href="../7-headto-sym-debugger/4-syms-resolve-reloc.html">
            
                    
                    7.4 Symbol Resolution & Relocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../7-headto-sym-debugger/5-loading.html">
            
                <a href="../7-headto-sym-debugger/5-loading.html">
            
                    
                    7.5 Loading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../7-headto-sym-debugger/6-gopkg-debug/">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/">
            
                    
                    7.6 Go Standard Library debug/*
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.6.1" data-path="../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                    
                    7.6.1 debug/elf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.2" data-path="../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                    
                    7.6.2 debug/gosym
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.3" data-path="../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                <a href="../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                    
                    7.6.3 debug/dwarf
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../7-headto-sym-debugger/7-headto-dwarf/">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/">
            
                    
                    7.7 Advancing to DWARF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.7.1" data-path="../7-headto-sym-debugger/7-headto-dwarf/1-gopkgs-about-dwarf.html">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/1-gopkgs-about-dwarf.html">
            
                    
                    7.7.1 Related Go Packages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.2" data-path="../7-headto-sym-debugger/7-headto-dwarf/2-delve-into-internals.html">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/2-delve-into-internals.html">
            
                    
                    7.7.2 How to Crack Those Details
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.3" data-path="../7-headto-sym-debugger/7-headto-dwarf/3-compiler-gen-dwarfdata.html">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/3-compiler-gen-dwarfdata.html">
            
                    
                    7.7.3 Compiler Generated DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.4" data-path="../7-headto-sym-debugger/7-headto-dwarf/4-linker-gen-dwarfdata.html">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/4-linker-gen-dwarfdata.html">
            
                    
                    7.7.4 Linker Generated DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.5" data-path="../7-headto-sym-debugger/7-headto-dwarf/5-headto-dwarf.html">
            
                <a href="../7-headto-sym-debugger/7-headto-dwarf/5-headto-dwarf.html">
            
                    
                    7.7.5 Understanding DWARF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../8-dwarf/">
            
                <a href="../8-dwarf/">
            
                    
                    8 Debug Information Standard: DWARF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../8-dwarf/1-history.html">
            
                <a href="../8-dwarf/1-history.html">
            
                    
                    8.1 DWARF Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../8-dwarf/2-overview.html">
            
                <a href="../8-dwarf/2-overview.html">
            
                    
                    8.2 DWARF Content Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../8-dwarf/3-dwarfdata.html">
            
                <a href="../8-dwarf/3-dwarfdata.html">
            
                    
                    8.3 DWARF Data Classification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../8-dwarf/4-die/">
            
                <a href="../8-dwarf/4-die/">
            
                    
                    8.4 DIE Detailed Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.4.1" data-path="../8-dwarf/4-die/1-desc-data-type.html">
            
                <a href="../8-dwarf/4-die/1-desc-data-type.html">
            
                    
                    8.4.1 DIE Describing Data and Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.2" data-path="../8-dwarf/4-die/2-desc-locations.html">
            
                <a href="../8-dwarf/4-die/2-desc-locations.html">
            
                    
                    8.4.2 Location Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.3" data-path="../8-dwarf/4-die/3-desc-code.html">
            
                <a href="../8-dwarf/4-die/3-desc-code.html">
            
                    
                    8.4.3 DIE Describing Executable Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.4" data-path="../8-dwarf/4-die/4-encoding.html">
            
                <a href="../8-dwarf/4-die/4-encoding.html">
            
                    
                    8.4.4 DIE Data Encoding
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../8-dwarf/5-other/">
            
                <a href="../8-dwarf/5-other/">
            
                    
                    8.5 Other Debug Data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.5.1" data-path="../8-dwarf/5-other/1-accelerated-access.html">
            
                <a href="../8-dwarf/5-other/1-accelerated-access.html">
            
                    
                    8.5.1 Accelerated Access
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.2" data-path="../8-dwarf/5-other/2-lineno-table.html">
            
                <a href="../8-dwarf/5-other/2-lineno-table.html">
            
                    
                    8.5.2 Line Number Table Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.3" data-path="../8-dwarf/5-other/3-callframe-info.html">
            
                <a href="../8-dwarf/5-other/3-callframe-info.html">
            
                    
                    8.5.3 Call Frame Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.4" data-path="../8-dwarf/5-other/4-macro-info.html">
            
                <a href="../8-dwarf/5-other/4-macro-info.html">
            
                    
                    8.5.4 Macro Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.5" data-path="../8-dwarf/5-other/5-varlen-data.html">
            
                <a href="../8-dwarf/5-other/5-varlen-data.html">
            
                    
                    8.5.5 Variable Length Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.6" data-path="../8-dwarf/5-other/6-shrink-data.html">
            
                <a href="../8-dwarf/5-other/6-shrink-data.html">
            
                    
                    8.5.6 Compressed DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.7" data-path="../8-dwarf/5-other/7-elf-sections.html">
            
                <a href="../8-dwarf/5-other/7-elf-sections.html">
            
                    
                    8.5.7 ELF Sections
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="../8-dwarf/6-practices.html">
            
                <a href="../8-dwarf/6-practices.html">
            
                    
                    8.6 DWARF Parsing and Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="../8-dwarf/7-summary.html">
            
                <a href="../8-dwarf/7-summary.html">
            
                    
                    8.7 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../9-develop-sym-debugger/">
            
                <a href="../9-develop-sym-debugger/">
            
                    
                    9 Developing Go Symbol-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/">
            
                    
                    9.1 Architecture Design
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1.1" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/1-ç°ä»£è°è¯å¨æ¶æ.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/1-ç°ä»£è°è¯å¨æ¶æ.html">
            
                    
                    9.1.1 Modern Debugger Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.2" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/2-åç«¯UIå±è®¾è®¡.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/2-åç«¯UIå±è®¾è®¡.html">
            
                    
                    9.1.2 Frontend UI Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.3" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/3-Serviceå±è®¾è®¡.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/3-Serviceå±è®¾è®¡.html">
            
                    
                    9.1.3 Service Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.4" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/4-åç«¯ç¬¦å·å±è®¾è®¡.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/4-åç«¯ç¬¦å·å±è®¾è®¡.html">
            
                    
                    9.1.4 Backend Symbol Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.5" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/5-åç«¯ç®æ å±è®¾è®¡.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/5-åç«¯ç®æ å±è®¾è®¡.html">
            
                    
                    9.1.5 Backend Target Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.6" data-path="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/6-æ¥å¿ç³»ç»è®¾è®¡.html">
            
                <a href="../9-develop-sym-debugger/1-æ¶æè®¾è®¡/6-æ¥å¿ç³»ç»è®¾è®¡.html">
            
                    
                    9.1.6 Logging System Design
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/">
            
                    
                    9.2 Core Debugging Logic
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.2.1" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/00-cmds.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/00-cmds.html">
            
                    
                    9.2.00 Core Debugging Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.2" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/01-debug-session.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/01-debug-session.html">
            
                    
                    9.2.01 Opening Debug Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.3" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/11-tinydbg_attach.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/11-tinydbg_attach.html">
            
                    
                    9.2.11 tinydbg attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.4" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/12-tinydbg_attach_waitfor.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/12-tinydbg_attach_waitfor.html">
            
                    
                    9.2.12 tinydbg attach+waitfor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.5" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/13-tinydbg_exec.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/13-tinydbg_exec.html">
            
                    
                    9.2.13 tinydbg exec
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.6" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/14-tinydbg_debug.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/14-tinydbg_debug.html">
            
                    
                    9.2.14 tinydbg debug
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.7" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/15-tinydbg_core1.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/15-tinydbg_core1.html">
            
                    
                    9.2.15 tinydbg core - part1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.8" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/15-tinydbg_core2.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/15-tinydbg_core2.html">
            
                    
                    9.2.15 tinydbg core - part2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.9" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/16-tinydbg_connect.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/16-tinydbg_connect.html">
            
                    
                    9.2.16 tinydbg connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.10" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/17-tinydbg_trace.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/17-tinydbg_trace.html">
            
                    
                    9.2.17 tinydbg trace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.11" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/21-disassemble.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/21-disassemble.html">
            
                    
                    9.2.21 tinydbg> disass
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.12" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/22-breakpoint.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/22-breakpoint.html">
            
                    
                    9.2.22 tinydbg> breakpoint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.13" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/23-breakpoints.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/23-breakpoints.html">
            
                    
                    9.2.23 tinydbg> breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.14" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/24-clear.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/24-clear.html">
            
                    
                    9.2.24 tinydbg> clear | toggle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.15" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/25-clearall.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/25-clearall.html">
            
                    
                    9.2.25 tinydbg> clearall
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.16" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/26-step.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/26-step.html">
            
                    
                    9.2.26 tinydbg> next | step | stepi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.17" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/27-continue.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/27-continue.html">
            
                    
                    9.2.27 Continue Execution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.18" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/28-pmem.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/28-pmem.html">
            
                    
                    9.2.28 View Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.19" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/29-regs.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/29-regs.html">
            
                    
                    9.2.29 View Registers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.20" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/30-call-frame.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/30-call-frame.html">
            
                    
                    9.2.30 Call Frame Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.21" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/31-vars.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/31-vars.html">
            
                    
                    9.2.31 Variables & Type System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.22" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/32-how_listfunctions_work.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/32-how_listfunctions_work.html">
            
                    
                    9.2.32 how ListFunctions work
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.23" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/32-funcs.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/32-funcs.html">
            
                    
                    9.2.32 funcs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.24" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/33-goroutines.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/33-goroutines.html">
            
                    
                    9.2.33 Goroutines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.25" data-path="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/34-multi-threads.html">
            
                <a href="../9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/34-multi-threads.html">
            
                    
                    9.2.34 Tracing Multi-threaded Programs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/">
            
                    
                    9.3 Advanced Feature Extensions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.3.1" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/100-howto_integrate_starlark.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/100-howto_integrate_starlark.html">
            
                    
                    9.3.100 Integrating starlark
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.2" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/101-howto_tracing_via_ebpf.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/101-howto_tracing_via_ebpf.html">
            
                    
                    9.3.101 Tracing with eBPF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.3" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/102-howto_syntax_highlight.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/102-howto_syntax_highlight.html">
            
                    
                    9.3.102 Implementing Syntax Highlighting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.4" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/103-howto_paging_output.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/103-howto_paging_output.html">
            
                    
                    9.3.103 Implementing Paged Output
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.5" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/104-howto_read_separate_dwarfdata.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/104-howto_read_separate_dwarfdata.html">
            
                    
                    9.3.104 Reading Separately Stored DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.6" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/105-howto_guess_substitutepath.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/105-howto_guess_substitutepath.html">
            
                    
                    9.3.105 Automatic Source File Path Mapping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.7" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/106-howto_redirect_target_io.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/106-howto_redirect_target_io.html">
            
                    
                    9.3.106 Implementing Target Process IO Redirection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.8" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/107-howto_customize_tinydbg.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/107-howto_customize_tinydbg.html">
            
                    
                    9.3.107 Supporting User Preferences
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.9" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/108-howto_accept_multiclient.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/108-howto_accept_multiclient.html">
            
                    
                    9.3.108 Supporting Multi-client Debug Mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.10" data-path="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/109-howto_transcript_debugging.html">
            
                <a href="../9-develop-sym-debugger/3-é«çº§åè½æ©å±/109-howto_transcript_debugging.html">
            
                    
                    9.3.109 Supporting Debug Activity Logging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../10-extras/">
            
                <a href="../10-extras/">
            
                    
                    10 Mainstream Debugging Technology Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../10-extras/1-development-of-debugger.html">
            
                <a href="../10-extras/1-development-of-debugger.html">
            
                    
                    10.1 Debugger Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../10-extras/2-development-of-logging.html">
            
                <a href="../10-extras/2-development-of-logging.html">
            
                    
                    10.2 Logging System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="../10-extras/3-development-of-metrics.html">
            
                <a href="../10-extras/3-development-of-metrics.html">
            
                    
                    10.3 Metrics System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="../10-extras/4-development-of-tracing.html">
            
                <a href="../10-extras/4-development-of-tracing.html">
            
                    
                    10.4 Tracing System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="../10-extras/5-development-of-bisect.html">
            
                <a href="../10-extras/5-development-of-bisect.html">
            
                    
                    10.5 Bisect Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="../10-extras/6-development-of-ebpf.html">
            
                <a href="../10-extras/6-development-of-ebpf.html">
            
                    
                    10.6 eBPF Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="../10-extras/7-development-of-replay.html">
            
                <a href="../10-extras/7-development-of-replay.html">
            
                    
                    10.7 Record and Replay Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="../10-extras/8-development-of-debug-dsys.html">
            
                <a href="../10-extras/8-development-of-debug-dsys.html">
            
                    
                    10.8 Distributed Debugging Development History
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../11-thanks/">
            
                <a href="../11-thanks/">
            
                    
                    11 Acknowledgments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../12-appendix/">
            
                <a href="../12-appendix/">
            
                    
                    12 Appendix
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../12-appendix/1-go-programme-start.html">
            
                <a href="../12-appendix/1-go-programme-start.html">
            
                    
                    12.1 Go Program Startup Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../12-appendix/2-auto-trace-cloned-threads.html">
            
                <a href="../12-appendix/2-auto-trace-cloned-threads.html">
            
                    
                    12.2 Automatic Thread Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../12-appendix/3-git-bisect.html">
            
                <a href="../12-appendix/3-git-bisect.html">
            
                    
                    12.3 git bisect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="../12-appendix/80-go-tool-compile.html">
            
                <a href="../12-appendix/80-go-tool-compile.html">
            
                    
                    12.10 Compilation Toolchain/compile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="../12-appendix/81-go-tool-asm.html">
            
                <a href="../12-appendix/81-go-tool-asm.html">
            
                    
                    12.11 Compilation Toolchain/asm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="../12-appendix/82-go-tool-link.html">
            
                <a href="../12-appendix/82-go-tool-link.html">
            
                    
                    12.12 Compilation Toolchain/link
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="../12-appendix/90-why-buildid-loaded.html">
            
                <a href="../12-appendix/90-why-buildid-loaded.html">
            
                    
                    12.13 More: GNU build-id+gobuildid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="../12-appendix/91-syntax-and-semantic-analysis.html">
            
                <a href="../12-appendix/91-syntax-and-semantic-analysis.html">
            
                    
                    12.14 More: Syntax Analysis vs Semantic Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.9" data-path="../12-appendix/92-why-gdb-uses-symtab.html">
            
                <a href="../12-appendix/92-why-gdb-uses-symtab.html">
            
                    
                    12.15 More: Why GDB Uses Symbol Table+DWARF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >6.21 Tracing Multi-threaded Programs 2</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="extended-reading-how-to-track-already-created-threads">Extended Reading: How to Track Already Created Threads</h2>
<h3 id="implementation-goal-tracking-already-created-threads">Implementation Goal: Tracking Already Created Threads</h3>
<p>The process being debugged is a multi-threaded program, and when we are ready to start debugging, these threads have already been created and are running. When we perform the debugger attach operation, we do not enumerate all threads and manually attach each one. For convenience, we only manually attach the process and hope that the program side can handle the attach operations for other threads within the process, except for the main thread.</p>
<p>Take Delve as an example, it may not immediately enumerate all threads and attach them one by one after <code>dlv attach &lt;pid&gt;</code>, but it should have this capability. For instance, when a debugger wants to track a specific thread, we can easily execute this operation, such as using <code>dlv&gt;threads</code> to view the thread list, and then <code>dlv&gt; thread &lt;n&gt;</code> to specifically track a particular thread.</p>
<p>Go programs are inherently multi-threaded, and they provide developers with goroutine concurrency interfaces, not thread-related interfaces. Therefore, even if Delve has this capability, it may not frequently use thread-related debugging commands. Due to the GMP scheduling model, you cannot be certain what is executing on the same thread, as the goroutines it executes will switch back and forth. Instead, <code>dlv&gt; goroutines</code> and <code>dlv&gt; goroutine &lt;n&gt;</code> are used more frequently.</p>
<p>Anyway, we must emphasize that we still hope to understand the underlying details of multi-threaded debugging. You might develop a debugger for another language in the future, right? It doesn&apos;t have to be Go. If that language is thread-oriented concurrency, the practical value of this knowledge still exists.</p>
<h3 id="basic-knowledge">Basic Knowledge</h3>
<p>How do we obtain all threads within a process? We can execute <code>top -H -p &lt;pid&gt;</code> to list all thread information of the specified process and parse to get all thread IDs. However, the Linux <code>/proc</code> virtual file system provides a more convenient way. In fact, we just need to traverse all directory names under <code>/proc/&lt;pid&gt;/task</code>. The Linux kernel maintains task information corresponding to threads in the above directory, and each directory name is a thread LWP&apos;s PID. Each directory&apos;s content contains some information about this task.</p>
<p>For example, let&apos;s look at some information for the process with PID=1:</p>
<pre><code class="lang-bash">root&#x1F980; ~ $ ls /proc/1/task/1/
arch_status  clear_refs  environ  io         mounts     oom_score_adj  <span class="hljs-built_in">sched</span>         stack    uid_map
attr         cmdline     exe      limits     net        pagemap        schedstat     <span class="hljs-built_in">stat</span>     wchan
auxv         comm        fd       maps       ns         personality    setgroups     statm
cgroup       cpuset      fdinfo   mem        oom_adj    projid_map     smaps         status
children     cwd         gid_map  mountinfo  oom_score  root           smaps_rollup  syscall
</code></pre>
<p>The <code>/proc</code> virtual file system is an interface provided by the kernel to interact with the kernel, which can be read and written. This is not a hack but a very standard method. Common tools like <code>top</code>, <code>vmstat</code>, <code>cgroup</code>, etc., also achieve related functions by accessing <code>/proc</code>.
OK, for our debugger, we currently only need to know:</p>
<ul>
<li>To enumerate all threads of a process, we traverse the directories under <code>/proc/&lt;pid&gt;/task</code>;</li>
<li>To read its complete instruction data, we read the <code>exe</code> file in the directory;</li>
<li>To read its startup parameter data, for convenience in restarting the debugged process or restarting debugging, we read the <code>cmdline</code> file in the directory;</li>
</ul>
<p>OK, we can ignore the others for now.</p>
<h3 id="design-implementation">Design Implementation</h3>
<p>The implementation code for this part can be found in <a href="https://github.com/hitzhangjie/golang-debugger-lessons" target="_blank">hitzhangjie/golang-debugger-lessons</a> / 21_trace_old_threads.</p>
<p>First, for convenience in testing, we prepare a test program <code>testdata/fork_noquit.c</code>, similar to the previous section&apos;s <code>testdata/fork.c</code>. It creates threads and prints PID and TID information, but the difference is that the threads here never exit, mainly to give us more time for debugging and avoid tracking failures due to thread exit.</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-keyword">pid_t</span> gettid(<span class="hljs-keyword">void</span>);

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">threadfunc</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;process: %d, thread: %u\n&quot;</span>, getpid(), syscall(SYS_gettid));
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        sleep(<span class="hljs-number">1</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;process: %d, thread: %u\n&quot;</span>, getpid(), syscall(SYS_gettid));

    <span class="hljs-keyword">pthread_t</span> tid;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
    {
        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">int</span> ret = pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, threadfunc, <span class="hljs-literal">NULL</span>);
            <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pthread_create error: %d\n&quot;</span>, ret);
                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
            }
        }
        sleep(<span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        sleep(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p>This program can be compiled with <code>gcc -o fork_noquit fork_noquit.c -lpthread</code>, and then run <code>./fork_noquit</code> to observe its output.</p>
<p>Next, let&apos;s look at the debugger&apos;s code logic. This is mainly to demonstrate how to track already created threads in the process being debugged, and how to switch from tracking one thread to another.</p>
<p>The core logic of the program is as follows:</p>
<ul>
<li>We execute <code>./21_trace_old_threads $(pidof fork_noquit)</code>, which checks if the process exists.</li>
<li>Then, we enumerate the threads already created in the process by reading information from <code>/proc</code> and output all thread IDs.</li>
<li>We prompt the user to input a target thread ID to track, and after input, we start tracking this thread.</li>
<li>When tracking a thread, if there was a previously tracked thread, we need to stop tracking the old thread before continuing to track the new thread.</li>
</ul>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">&quot;fmt&quot;</span>
    <span class="hljs-string">&quot;os&quot;</span>
    <span class="hljs-string">&quot;os/exec&quot;</span>
    <span class="hljs-string">&quot;runtime&quot;</span>
    <span class="hljs-string">&quot;strconv&quot;</span>
    <span class="hljs-string">&quot;syscall&quot;</span>
    <span class="hljs-string">&quot;time&quot;</span>
)

<span class="hljs-keyword">var</span> usage = <span class="hljs-string">`Usage:
    go run main.go &lt;pid&gt;

    args:
    - pid: specify the pid of process to attach
`</span>

<span class="hljs-keyword">func</span> main() {
    runtime.LockOSThread()

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) != <span class="hljs-number">2</span> {
        fmt.Println(usage)
        os.Exit(<span class="hljs-number">1</span>)
    }

    fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;===step1===: check target process existed or not\n&quot;</span>)
    <span class="hljs-comment">// pid</span>
    pid, err := strconv.Atoi(os.Args[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }

    <span class="hljs-keyword">if</span> !checkPid(<span class="hljs-keyword">int</span>(pid)) {
        fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;process %d not existed\n\n&quot;</span>, pid)
        os.Exit(<span class="hljs-number">1</span>)
    }

    <span class="hljs-comment">// enumerate all threads</span>
    fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;===step2===: enumerate created threads by reading /proc\n&quot;</span>)

    <span class="hljs-comment">// read dir entries of /proc/&lt;pid&gt;/task/</span>
    threads, err := readThreadIDs(pid)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;threads: %v\n&quot;</span>, threads)

    <span class="hljs-comment">// prompt user which thread to attach</span>
    <span class="hljs-keyword">var</span> last <span class="hljs-keyword">int64</span>

    <span class="hljs-comment">// attach thread &lt;n&gt;, or switch thread to another one thread &lt;m&gt;</span>
    <span class="hljs-keyword">for</span> {
        fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;===step3===: supposing running `dlv&gt; thread &lt;n&gt;` here\n&quot;</span>)
        <span class="hljs-keyword">var</span> target <span class="hljs-keyword">int64</span>
        n, err := fmt.Fscanf(os.Stdin, <span class="hljs-string">&quot;%d\n&quot;</span>, &amp;target)
        <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> || err != <span class="hljs-literal">nil</span> || target &lt;= <span class="hljs-number">0</span> {
            <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;invalid input, thread id should &gt; 0&quot;</span>)
        }

        <span class="hljs-keyword">if</span> last &gt; <span class="hljs-number">0</span> {
            <span class="hljs-keyword">if</span> err := syscall.PtraceDetach(<span class="hljs-keyword">int</span>(last)); err != <span class="hljs-literal">nil</span> {
                fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;switch from thread %d to thread %d error: %v\n&quot;</span>, last, target, err)
                os.Exit(<span class="hljs-number">1</span>)
            }
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;switch from thread %d thread %d\n&quot;</span>, last, target)
        }

        <span class="hljs-comment">// attach</span>
        err = syscall.PtraceAttach(<span class="hljs-keyword">int</span>(target))
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;thread %d attach error: %v\n\n&quot;</span>, target, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;process %d attach succ\n\n&quot;</span>, target)

        <span class="hljs-comment">// check target process stopped or not</span>
        <span class="hljs-keyword">var</span> status syscall.WaitStatus
        <span class="hljs-keyword">var</span> rusage syscall.Rusage
        _, err = syscall.Wait4(<span class="hljs-keyword">int</span>(target), &amp;status, <span class="hljs-number">0</span>, &amp;rusage)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;process %d wait error: %v\n\n&quot;</span>, target, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        <span class="hljs-keyword">if</span> !status.Stopped() {
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;process %d not stopped\n\n&quot;</span>, target)
            os.Exit(<span class="hljs-number">1</span>)
        }
        fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;process %d stopped\n\n&quot;</span>, target)

        regs := syscall.PtraceRegs{}
        <span class="hljs-keyword">if</span> err := syscall.PtraceGetRegs(<span class="hljs-keyword">int</span>(target), &amp;regs); err != <span class="hljs-literal">nil</span> {
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;get regs fail: %v\n&quot;</span>, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        fmt.Fprintf(os.Stdout, <span class="hljs-string">&quot;tracee stopped at %0x\n&quot;</span>, regs.PC())

        last = target
        time.Sleep(time.Second)
    }
}

<span class="hljs-comment">// checkPid check whether pid is valid process&apos;s id</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// On Unix systems, os.FindProcess always succeeds and returns a Process for</span>
<span class="hljs-comment">// the given pid, regardless of whether the process exists.</span>
<span class="hljs-keyword">func</span> checkPid(pid <span class="hljs-keyword">int</span>) <span class="hljs-keyword">bool</span> {
    out, err := exec.Command(<span class="hljs-string">&quot;kill&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>, strconv.Itoa(pid)).CombinedOutput()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }

    <span class="hljs-comment">// output error message, means pid is invalid</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">string</span>(out) != <span class="hljs-string">&quot;&quot;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// reads all thread IDs associated with a given process ID.</span>
<span class="hljs-keyword">func</span> readThreadIDs(pid <span class="hljs-keyword">int</span>) ([]<span class="hljs-keyword">int</span>, error) {
    dir := fmt.Sprintf(<span class="hljs-string">&quot;/proc/%d/task&quot;</span>, pid)
    files, err := os.ReadDir(dir)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-keyword">var</span> threads []<span class="hljs-keyword">int</span>
    <span class="hljs-keyword">for</span> _, file := <span class="hljs-keyword">range</span> files {
        tid, err := strconv.Atoi(file.Name())
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> { <span class="hljs-comment">// Ensure that it&apos;s a valid positive integer</span>
            <span class="hljs-keyword">continue</span>
        }
        threads = <span class="hljs-built_in">append</span>(threads, tid)
    }
    <span class="hljs-keyword">return</span> threads, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 id="code-testing">Code Testing</h3>
<ol>
<li>First, let&apos;s look at <code>testdata/fork_noquit.c</code>. This program creates a pthread thread every few seconds.</li>
</ol>
<p>The main thread and other threads will print the PID and TID (where TID is the corresponding LWP&apos;s PID) of the thread.</p>
<blockquote>
<p>Note: The difference between <code>fork_noquit.c</code> and <code>fork.c</code> is that each thread continuously <code>sleep(1)</code> and never exits. The purpose is that our test takes a long time, and keeping the threads from exiting can avoid failures when we input a thread ID to execute <code>attach thread</code> or <code>switch thread1 to thread2</code> due to the thread already exiting.</p>
</blockquote>
<p>Below is the execution of the program waiting to be debugged:</p>
<pre><code class="lang-bash">zhangjie&#x1F980; testdata(master) $ ./fork_noquit
process: 12368, thread: 12368
process: 12368, thread: 12369
process: 12368, thread: 12527
process: 12368, thread: 12599
process: 12368, thread: 12661
...
</code></pre>
<ol>
<li>We will simultaneously observe the execution of <code>./21_trace_old_threads &lt;fork_noquit program process pid&gt;</code>.</li>
</ol>
<pre><code class="lang-bash">zhangjie&#x1F980; 21_trace_old_threads(master) $ ./21_trace_old_threads 12368
===step1===: check target process existed or not

===step2===: enumerate created threads by reading /proc
threads: [12368 12369 12527 12599 12661 12725 12798 12864 12934 13004 13075]    &lt;= created thread IDs

===step3===: supposing running `dlv&gt; thread &lt;n&gt;` here
12369
process 12369 attach succ                                                       &lt;= prompt user input and attach thread
process 12369 stopped
tracee stopped at 7f06c29cf098

===step3===: supposing running `dlv&gt; thread &lt;n&gt;` here
12527
switch from thread 12369 thread 12527
process 12527 attach succ                                                       &lt;= prompt user input and switch thread
process 12527 stopped
tracee stopped at 7f06c29cf098

===step3===: supposing running `dlv&gt; thread &lt;n&gt;` here
</code></pre>
<ol>
<li>Above, we input two thread IDs, the first one was 12369, and the second one was 12527. Let&apos;s see how the thread states changed during these two inputs.</li>
</ol>
<p>Initially, without input, the thread states were all S, indicating Sleep, because the threads were continuously doing <code>while(1) {sleep(1);}</code>, which is understandable.</p>
<pre><code class="lang-bash">$ top -H -p 12368

top - 00:54:17 up 8 days,  2:10,  2 users,  load average: 0.02, 0.06, 0.08
Threads:   7 total,   0 running,   7 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.1 us,  0.1 sy,  0.0 ni, 99.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  31964.6 total,  26011.4 free,   4052.5 used,   1900.7 buff/cache
MiB Swap:   8192.0 total,   8192.0 free,      0.0 used.  27333.2 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
12368 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12369 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12527 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12599 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12661 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12725 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
12798 zhangjie  20   0   55804    888    800 S   0.0   0.0   0:00.00 fork_noquit
...
</code></pre>
<p>After we input 12369, the state of thread 12369 changed from S to t, indicating that the thread is now being debugged by the debugger (traced state).</p>
<pre><code class="lang-bash">12369 zhangjie  20   0   88588    888    800 t   0.0   0.0   0:00.00 fork_noquit
</code></pre>
<p>After we input 12527, the debugging behavior switched from tracking thread 12369 to tracking 12527. We saw that thread 12369 switched back from t to S, and 12527 switched from S to t.</p>
<pre><code class="lang-bash">12369 zhangjie  20   0   88588    888    800 S   0.0   0.0   0:00.00 fork_noquit
12527 zhangjie  20   0   88588    888    800 t   0.0   0.0   0:00.00 fork_noquit
</code></pre>
<p>OK, press Ctrl+C to kill the <code>./21_trace_old_threads</code> process, and then we continue to observe the thread states. They will automatically change from t to S, because the kernel is responsible for cleanup, i.e., resuming all tracees after the tracer exits.</p>
<h3 id="further-discussion">Further Discussion</h3>
<p>When debugging multi-threaded programs, you might only track one thread or track multiple threads simultaneously. The final implementation form depends on the debugger&apos;s interaction design. For example, command-line debuggers often tend to track one thread due to interface interaction reasons, but some graphical IDEs might prefer to provide the ability to track multiple threads simultaneously (I often did this when debugging Java multi-threaded programs with Eclipse). We demonstrated how to implement this capability here, and readers should be able to implement tracking multiple threads simultaneously on their own.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="20-trace_new_threads.html" class="navigation navigation-prev " aria-label="Previous page: 6.20 Tracing Multi-threaded Programs 1">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="80-aslr.html" class="navigation navigation-next " aria-label="Next page: 6.80 Understanding ASLR">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"6.21 Tracing Multi-threaded Programs 2","level":"1.6.17","depth":2,"next":{"title":"6.80 Understanding ASLR","level":"1.6.18","depth":2,"path":"6-develop-inst-debugger/80-aslr.md","ref":"6-develop-inst-debugger/80-aslr.md","articles":[]},"previous":{"title":"6.20 Tracing Multi-threaded Programs 1","level":"1.6.16","depth":2,"path":"6-develop-inst-debugger/20-trace_new_threads.md","ref":"6-develop-inst-debugger/20-trace_new_threads.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["md-toc"],"pluginsConfig":{"intopic-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true,"label":{"en":"In This Article","zh":"æ¬æç®å½"}},"md-toc":{"label":"In this article","selector":".markdown-section h2","visible":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"6-develop-inst-debugger/21-trace_old_threads.md","mtime":"2025-06-15T09:40:33.736Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-06-15T18:01:33.391Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/anchor.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/gumshoe.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-md-toc/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>



<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>9.2.01 Opening Debug Session Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-md-toc/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="11-tinydbg_attach.html" />
    
    
    <link rel="prev" href="00-cmds.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    1 Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../2-preface/">
            
                <a href="../../2-preface/">
            
                    
                    2 Preface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../3-terms/">
            
                <a href="../../3-terms/">
            
                    
                    3 Common Terms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../4-basics/">
            
                <a href="../../4-basics/">
            
                    
                    4 Software Debugging Basics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../4-basics/1-purposes.html">
            
                <a href="../../4-basics/1-purposes.html">
            
                    
                    4.1 Debugging Purposes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../4-basics/2-dependencies.html">
            
                <a href="../../4-basics/2-dependencies.html">
            
                    
                    4.2 Debugging Dependencies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../../4-basics/3-countertactics.html">
            
                <a href="../../4-basics/3-countertactics.html">
            
                    
                    4.3 Anti-Debugging Techniques
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../5-debugger-skeleton/">
            
                <a href="../../5-debugger-skeleton/">
            
                    
                    5 Entering Debugger Development
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../5-debugger-skeleton/1-debugger_skeleton.html">
            
                <a href="../../5-debugger-skeleton/1-debugger_skeleton.html">
            
                    
                    5.1 Debugger Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../5-debugger-skeleton/2-debugger_demo.html">
            
                <a href="../../5-debugger-skeleton/2-debugger_demo.html">
            
                    
                    5.2 Debugger Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../6-develop-inst-debugger/">
            
                <a href="../../6-develop-inst-debugger/">
            
                    
                    6 Developing Go Instruction-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../../6-develop-inst-debugger/1-process_start.html">
            
                <a href="../../6-develop-inst-debugger/1-process_start.html">
            
                    
                    6.1 Process Launch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../../6-develop-inst-debugger/2-process_attach.html">
            
                <a href="../../6-develop-inst-debugger/2-process_attach.html">
            
                    
                    6.2 Process Attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../../6-develop-inst-debugger/3-process_start_attach.html">
            
                <a href="../../6-develop-inst-debugger/3-process_start_attach.html">
            
                    
                    6.3 Launch & Attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../../6-develop-inst-debugger/4-debug-session.html">
            
                <a href="../../6-develop-inst-debugger/4-debug-session.html">
            
                    
                    6.4 Debug Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../../6-develop-inst-debugger/5-disassemble.html">
            
                <a href="../../6-develop-inst-debugger/5-disassemble.html">
            
                    
                    6.5 Disassembly
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../../6-develop-inst-debugger/6-breakpoint.html">
            
                <a href="../../6-develop-inst-debugger/6-breakpoint.html">
            
                    
                    6.6 Adding Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../../6-develop-inst-debugger/7-breakpoints.html">
            
                <a href="../../6-develop-inst-debugger/7-breakpoints.html">
            
                    
                    6.7 Listing Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../../6-develop-inst-debugger/8-clear.html">
            
                <a href="../../6-develop-inst-debugger/8-clear.html">
            
                    
                    6.8 Removing Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="../../6-develop-inst-debugger/9-clearall.html">
            
                <a href="../../6-develop-inst-debugger/9-clearall.html">
            
                    
                    6.9 Clearing All Breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="../../6-develop-inst-debugger/10-step.html">
            
                <a href="../../6-develop-inst-debugger/10-step.html">
            
                    
                    6.10 Stepping Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.11" data-path="../../6-develop-inst-debugger/11-continue.html">
            
                <a href="../../6-develop-inst-debugger/11-continue.html">
            
                    
                    6.11 Running to Breakpoint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.12" data-path="../../6-develop-inst-debugger/12-pmem.html">
            
                <a href="../../6-develop-inst-debugger/12-pmem.html">
            
                    
                    6.12 Printing Memory Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.13" data-path="../../6-develop-inst-debugger/13-pregs.html">
            
                <a href="../../6-develop-inst-debugger/13-pregs.html">
            
                    
                    6.13 Printing Register Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.14" data-path="../../6-develop-inst-debugger/14-set-mem.html">
            
                <a href="../../6-develop-inst-debugger/14-set-mem.html">
            
                    
                    6.14 Modifying Memory Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.15" data-path="../../6-develop-inst-debugger/15-set-regs.html">
            
                <a href="../../6-develop-inst-debugger/15-set-regs.html">
            
                    
                    6.15 Modifying Register Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.16" data-path="../../6-develop-inst-debugger/20-trace_new_threads.html">
            
                <a href="../../6-develop-inst-debugger/20-trace_new_threads.html">
            
                    
                    6.20 Tracing Multi-threaded Programs 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.17" data-path="../../6-develop-inst-debugger/21-trace_old_threads.html">
            
                <a href="../../6-develop-inst-debugger/21-trace_old_threads.html">
            
                    
                    6.21 Tracing Multi-threaded Programs 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.18" data-path="../../6-develop-inst-debugger/80-aslr.html">
            
                <a href="../../6-develop-inst-debugger/80-aslr.html">
            
                    
                    6.80 Understanding ASLR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.19" data-path="../../6-develop-inst-debugger/99-more.html">
            
                <a href="../../6-develop-inst-debugger/99-more.html">
            
                    
                    6.99 More...
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../../7-headto-sym-debugger/">
            
                <a href="../../7-headto-sym-debugger/">
            
                    
                    7 Advancing to Symbol-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../../7-headto-sym-debugger/1-how-go-build-works.html">
            
                <a href="../../7-headto-sym-debugger/1-how-go-build-works.html">
            
                    
                    7.1 Go Build Internals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../../7-headto-sym-debugger/2-elf.html">
            
                <a href="../../7-headto-sym-debugger/2-elf.html">
            
                    
                    7.2 Understanding ELF Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../../7-headto-sym-debugger/3-syms.html">
            
                <a href="../../7-headto-sym-debugger/3-syms.html">
            
                    
                    7.3 Symbols & Symbol Tables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../../7-headto-sym-debugger/4-syms-resolve-reloc.html">
            
                <a href="../../7-headto-sym-debugger/4-syms-resolve-reloc.html">
            
                    
                    7.4 Symbol Resolution & Relocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="../../7-headto-sym-debugger/5-loading.html">
            
                <a href="../../7-headto-sym-debugger/5-loading.html">
            
                    
                    7.5 Loading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="../../7-headto-sym-debugger/6-gopkg-debug/">
            
                <a href="../../7-headto-sym-debugger/6-gopkg-debug/">
            
                    
                    7.6 Go Standard Library debug/*
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.6.1" data-path="../../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                <a href="../../7-headto-sym-debugger/6-gopkg-debug/1-elf.html">
            
                    
                    7.6.1 debug/elf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.2" data-path="../../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                <a href="../../7-headto-sym-debugger/6-gopkg-debug/2-gosym.html">
            
                    
                    7.6.2 debug/gosym
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.6.3" data-path="../../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                <a href="../../7-headto-sym-debugger/6-gopkg-debug/3-dwarf.html">
            
                    
                    7.6.3 debug/dwarf
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="../../7-headto-sym-debugger/7-headto-dwarf/">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/">
            
                    
                    7.7 Advancing to DWARF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.7.1" data-path="../../7-headto-sym-debugger/7-headto-dwarf/1-gopkgs-about-dwarf.html">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/1-gopkgs-about-dwarf.html">
            
                    
                    7.7.1 Related Go Packages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.2" data-path="../../7-headto-sym-debugger/7-headto-dwarf/2-delve-into-internals.html">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/2-delve-into-internals.html">
            
                    
                    7.7.2 How to Crack Those Details
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.3" data-path="../../7-headto-sym-debugger/7-headto-dwarf/3-compiler-gen-dwarfdata.html">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/3-compiler-gen-dwarfdata.html">
            
                    
                    7.7.3 Compiler Generated DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.4" data-path="../../7-headto-sym-debugger/7-headto-dwarf/4-linker-gen-dwarfdata.html">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/4-linker-gen-dwarfdata.html">
            
                    
                    7.7.4 Linker Generated DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7.5" data-path="../../7-headto-sym-debugger/7-headto-dwarf/5-headto-dwarf.html">
            
                <a href="../../7-headto-sym-debugger/7-headto-dwarf/5-headto-dwarf.html">
            
                    
                    7.7.5 Understanding DWARF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../../8-dwarf/">
            
                <a href="../../8-dwarf/">
            
                    
                    8 Debug Information Standard: DWARF
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../../8-dwarf/1-history.html">
            
                <a href="../../8-dwarf/1-history.html">
            
                    
                    8.1 DWARF Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../../8-dwarf/2-overview.html">
            
                <a href="../../8-dwarf/2-overview.html">
            
                    
                    8.2 DWARF Content Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../../8-dwarf/3-dwarfdata.html">
            
                <a href="../../8-dwarf/3-dwarfdata.html">
            
                    
                    8.3 DWARF Data Classification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../../8-dwarf/4-die/">
            
                <a href="../../8-dwarf/4-die/">
            
                    
                    8.4 DIE Detailed Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.4.1" data-path="../../8-dwarf/4-die/1-desc-data-type.html">
            
                <a href="../../8-dwarf/4-die/1-desc-data-type.html">
            
                    
                    8.4.1 DIE Describing Data and Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.2" data-path="../../8-dwarf/4-die/2-desc-locations.html">
            
                <a href="../../8-dwarf/4-die/2-desc-locations.html">
            
                    
                    8.4.2 Location Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.3" data-path="../../8-dwarf/4-die/3-desc-code.html">
            
                <a href="../../8-dwarf/4-die/3-desc-code.html">
            
                    
                    8.4.3 DIE Describing Executable Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4.4" data-path="../../8-dwarf/4-die/4-encoding.html">
            
                <a href="../../8-dwarf/4-die/4-encoding.html">
            
                    
                    8.4.4 DIE Data Encoding
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../../8-dwarf/5-other/">
            
                <a href="../../8-dwarf/5-other/">
            
                    
                    8.5 Other Debug Data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.5.1" data-path="../../8-dwarf/5-other/1-accelerated-access.html">
            
                <a href="../../8-dwarf/5-other/1-accelerated-access.html">
            
                    
                    8.5.1 Accelerated Access
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.2" data-path="../../8-dwarf/5-other/2-lineno-table.html">
            
                <a href="../../8-dwarf/5-other/2-lineno-table.html">
            
                    
                    8.5.2 Line Number Table Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.3" data-path="../../8-dwarf/5-other/3-callframe-info.html">
            
                <a href="../../8-dwarf/5-other/3-callframe-info.html">
            
                    
                    8.5.3 Call Frame Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.4" data-path="../../8-dwarf/5-other/4-macro-info.html">
            
                <a href="../../8-dwarf/5-other/4-macro-info.html">
            
                    
                    8.5.4 Macro Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.5" data-path="../../8-dwarf/5-other/5-varlen-data.html">
            
                <a href="../../8-dwarf/5-other/5-varlen-data.html">
            
                    
                    8.5.5 Variable Length Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.6" data-path="../../8-dwarf/5-other/6-shrink-data.html">
            
                <a href="../../8-dwarf/5-other/6-shrink-data.html">
            
                    
                    8.5.6 Compressed DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5.7" data-path="../../8-dwarf/5-other/7-elf-sections.html">
            
                <a href="../../8-dwarf/5-other/7-elf-sections.html">
            
                    
                    8.5.7 ELF Sections
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="../../8-dwarf/6-practices.html">
            
                <a href="../../8-dwarf/6-practices.html">
            
                    
                    8.6 DWARF Parsing and Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="../../8-dwarf/7-summary.html">
            
                <a href="../../8-dwarf/7-summary.html">
            
                    
                    8.7 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../">
            
                <a href="../">
            
                    
                    9 Developing Go Symbol-Level Debugger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../1-æ¶æè®¾è®¡/">
            
                <a href="../1-æ¶æè®¾è®¡/">
            
                    
                    9.1 Architecture Design
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1.1" data-path="../1-æ¶æè®¾è®¡/1-ç°ä»£è°è¯å¨æ¶æ.html">
            
                <a href="../1-æ¶æè®¾è®¡/1-ç°ä»£è°è¯å¨æ¶æ.html">
            
                    
                    9.1.1 Modern Debugger Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.2" data-path="../1-æ¶æè®¾è®¡/2-åç«¯UIå±è®¾è®¡.html">
            
                <a href="../1-æ¶æè®¾è®¡/2-åç«¯UIå±è®¾è®¡.html">
            
                    
                    9.1.2 Frontend UI Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.3" data-path="../1-æ¶æè®¾è®¡/3-Serviceå±è®¾è®¡.html">
            
                <a href="../1-æ¶æè®¾è®¡/3-Serviceå±è®¾è®¡.html">
            
                    
                    9.1.3 Service Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.4" data-path="../1-æ¶æè®¾è®¡/4-åç«¯ç¬¦å·å±è®¾è®¡.html">
            
                <a href="../1-æ¶æè®¾è®¡/4-åç«¯ç¬¦å·å±è®¾è®¡.html">
            
                    
                    9.1.4 Backend Symbol Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.5" data-path="../1-æ¶æè®¾è®¡/5-åç«¯ç®æ å±è®¾è®¡.html">
            
                <a href="../1-æ¶æè®¾è®¡/5-åç«¯ç®æ å±è®¾è®¡.html">
            
                    
                    9.1.5 Backend Target Layer Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.6" data-path="../1-æ¶æè®¾è®¡/6-æ¥å¿ç³»ç»è®¾è®¡.html">
            
                <a href="../1-æ¶æè®¾è®¡/6-æ¥å¿ç³»ç»è®¾è®¡.html">
            
                    
                    9.1.6 Logging System Design
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="./">
            
                <a href="./">
            
                    
                    9.2 Core Debugging Logic
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.2.1" data-path="00-cmds.html">
            
                <a href="00-cmds.html">
            
                    
                    9.2.00 Core Debugging Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9.2.2" data-path="01-debug-session.html">
            
                <a href="01-debug-session.html">
            
                    
                    9.2.01 Opening Debug Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.3" data-path="11-tinydbg_attach.html">
            
                <a href="11-tinydbg_attach.html">
            
                    
                    9.2.11 tinydbg attach
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.4" data-path="12-tinydbg_attach_waitfor.html">
            
                <a href="12-tinydbg_attach_waitfor.html">
            
                    
                    9.2.12 tinydbg attach+waitfor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.5" data-path="13-tinydbg_exec.html">
            
                <a href="13-tinydbg_exec.html">
            
                    
                    9.2.13 tinydbg exec
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.6" data-path="14-tinydbg_debug.html">
            
                <a href="14-tinydbg_debug.html">
            
                    
                    9.2.14 tinydbg debug
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.7" data-path="15-tinydbg_core1.html">
            
                <a href="15-tinydbg_core1.html">
            
                    
                    9.2.15 tinydbg core - part1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.8" data-path="15-tinydbg_core2.html">
            
                <a href="15-tinydbg_core2.html">
            
                    
                    9.2.15 tinydbg core - part2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.9" data-path="16-tinydbg_connect.html">
            
                <a href="16-tinydbg_connect.html">
            
                    
                    9.2.16 tinydbg connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.10" data-path="17-tinydbg_trace.html">
            
                <a href="17-tinydbg_trace.html">
            
                    
                    9.2.17 tinydbg trace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.11" data-path="21-disassemble.html">
            
                <a href="21-disassemble.html">
            
                    
                    9.2.21 tinydbg> disass
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.12" data-path="22-breakpoint.html">
            
                <a href="22-breakpoint.html">
            
                    
                    9.2.22 tinydbg> breakpoint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.13" data-path="23-breakpoints.html">
            
                <a href="23-breakpoints.html">
            
                    
                    9.2.23 tinydbg> breakpoints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.14" data-path="24-clear.html">
            
                <a href="24-clear.html">
            
                    
                    9.2.24 tinydbg> clear | toggle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.15" data-path="25-clearall.html">
            
                <a href="25-clearall.html">
            
                    
                    9.2.25 tinydbg> clearall
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.16" data-path="26-step.html">
            
                <a href="26-step.html">
            
                    
                    9.2.26 tinydbg> next | step | stepi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.17" data-path="27-continue.html">
            
                <a href="27-continue.html">
            
                    
                    9.2.27 Continue Execution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.18" data-path="28-pmem.html">
            
                <a href="28-pmem.html">
            
                    
                    9.2.28 View Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.19" data-path="29-regs.html">
            
                <a href="29-regs.html">
            
                    
                    9.2.29 View Registers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.20" data-path="30-call-frame.html">
            
                <a href="30-call-frame.html">
            
                    
                    9.2.30 Call Frame Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.21" data-path="31-vars.html">
            
                <a href="31-vars.html">
            
                    
                    9.2.31 Variables & Type System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.22" data-path="32-how_listfunctions_work.html">
            
                <a href="32-how_listfunctions_work.html">
            
                    
                    9.2.32 how ListFunctions work
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.23" data-path="32-funcs.html">
            
                <a href="32-funcs.html">
            
                    
                    9.2.32 funcs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.24" data-path="33-goroutines.html">
            
                <a href="33-goroutines.html">
            
                    
                    9.2.33 Goroutines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.25" data-path="34-multi-threads.html">
            
                <a href="34-multi-threads.html">
            
                    
                    9.2.34 Tracing Multi-threaded Programs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../3-é«çº§åè½æ©å±/">
            
                <a href="../3-é«çº§åè½æ©å±/">
            
                    
                    9.3 Advanced Feature Extensions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.3.1" data-path="../3-é«çº§åè½æ©å±/100-howto_integrate_starlark.html">
            
                <a href="../3-é«çº§åè½æ©å±/100-howto_integrate_starlark.html">
            
                    
                    9.3.100 Integrating starlark
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.2" data-path="../3-é«çº§åè½æ©å±/101-howto_tracing_via_ebpf.html">
            
                <a href="../3-é«çº§åè½æ©å±/101-howto_tracing_via_ebpf.html">
            
                    
                    9.3.101 Tracing with eBPF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.3" data-path="../3-é«çº§åè½æ©å±/102-howto_syntax_highlight.html">
            
                <a href="../3-é«çº§åè½æ©å±/102-howto_syntax_highlight.html">
            
                    
                    9.3.102 Implementing Syntax Highlighting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.4" data-path="../3-é«çº§åè½æ©å±/103-howto_paging_output.html">
            
                <a href="../3-é«çº§åè½æ©å±/103-howto_paging_output.html">
            
                    
                    9.3.103 Implementing Paged Output
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.5" data-path="../3-é«çº§åè½æ©å±/104-howto_read_separate_dwarfdata.html">
            
                <a href="../3-é«çº§åè½æ©å±/104-howto_read_separate_dwarfdata.html">
            
                    
                    9.3.104 Reading Separately Stored DWARF Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.6" data-path="../3-é«çº§åè½æ©å±/105-howto_guess_substitutepath.html">
            
                <a href="../3-é«çº§åè½æ©å±/105-howto_guess_substitutepath.html">
            
                    
                    9.3.105 Automatic Source File Path Mapping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.7" data-path="../3-é«çº§åè½æ©å±/106-howto_redirect_target_io.html">
            
                <a href="../3-é«çº§åè½æ©å±/106-howto_redirect_target_io.html">
            
                    
                    9.3.106 Implementing Target Process IO Redirection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.8" data-path="../3-é«çº§åè½æ©å±/107-howto_customize_tinydbg.html">
            
                <a href="../3-é«çº§åè½æ©å±/107-howto_customize_tinydbg.html">
            
                    
                    9.3.107 Supporting User Preferences
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.9" data-path="../3-é«çº§åè½æ©å±/108-howto_accept_multiclient.html">
            
                <a href="../3-é«çº§åè½æ©å±/108-howto_accept_multiclient.html">
            
                    
                    9.3.108 Supporting Multi-client Debug Mode
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.10" data-path="../3-é«çº§åè½æ©å±/109-howto_transcript_debugging.html">
            
                <a href="../3-é«çº§åè½æ©å±/109-howto_transcript_debugging.html">
            
                    
                    9.3.109 Supporting Debug Activity Logging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../../10-extras/">
            
                <a href="../../10-extras/">
            
                    
                    10 Mainstream Debugging Technology Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../../10-extras/1-development-of-debugger.html">
            
                <a href="../../10-extras/1-development-of-debugger.html">
            
                    
                    10.1 Debugger Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../../10-extras/2-development-of-logging.html">
            
                <a href="../../10-extras/2-development-of-logging.html">
            
                    
                    10.2 Logging System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="../../10-extras/3-development-of-metrics.html">
            
                <a href="../../10-extras/3-development-of-metrics.html">
            
                    
                    10.3 Metrics System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="../../10-extras/4-development-of-tracing.html">
            
                <a href="../../10-extras/4-development-of-tracing.html">
            
                    
                    10.4 Tracing System Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="../../10-extras/5-development-of-bisect.html">
            
                <a href="../../10-extras/5-development-of-bisect.html">
            
                    
                    10.5 Bisect Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="../../10-extras/6-development-of-ebpf.html">
            
                <a href="../../10-extras/6-development-of-ebpf.html">
            
                    
                    10.6 eBPF Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="../../10-extras/7-development-of-replay.html">
            
                <a href="../../10-extras/7-development-of-replay.html">
            
                    
                    10.7 Record and Replay Development History
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="../../10-extras/8-development-of-debug-dsys.html">
            
                <a href="../../10-extras/8-development-of-debug-dsys.html">
            
                    
                    10.8 Distributed Debugging Development History
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../../11-thanks/">
            
                <a href="../../11-thanks/">
            
                    
                    11 Acknowledgments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../../12-appendix/">
            
                <a href="../../12-appendix/">
            
                    
                    12 Appendix
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../../12-appendix/1-go-programme-start.html">
            
                <a href="../../12-appendix/1-go-programme-start.html">
            
                    
                    12.1 Go Program Startup Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../../12-appendix/2-auto-trace-cloned-threads.html">
            
                <a href="../../12-appendix/2-auto-trace-cloned-threads.html">
            
                    
                    12.2 Automatic Thread Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../../12-appendix/3-git-bisect.html">
            
                <a href="../../12-appendix/3-git-bisect.html">
            
                    
                    12.3 git bisect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.4" data-path="../../12-appendix/80-go-tool-compile.html">
            
                <a href="../../12-appendix/80-go-tool-compile.html">
            
                    
                    12.10 Compilation Toolchain/compile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.5" data-path="../../12-appendix/81-go-tool-asm.html">
            
                <a href="../../12-appendix/81-go-tool-asm.html">
            
                    
                    12.11 Compilation Toolchain/asm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.6" data-path="../../12-appendix/82-go-tool-link.html">
            
                <a href="../../12-appendix/82-go-tool-link.html">
            
                    
                    12.12 Compilation Toolchain/link
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.7" data-path="../../12-appendix/90-why-buildid-loaded.html">
            
                <a href="../../12-appendix/90-why-buildid-loaded.html">
            
                    
                    12.13 More: GNU build-id+gobuildid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.8" data-path="../../12-appendix/91-syntax-and-semantic-analysis.html">
            
                <a href="../../12-appendix/91-syntax-and-semantic-analysis.html">
            
                    
                    12.14 More: Syntax Analysis vs Semantic Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.9" data-path="../../12-appendix/92-why-gdb-uses-symtab.html">
            
                <a href="../../12-appendix/92-why-gdb-uses-symtab.html">
            
                    
                    12.15 More: Why GDB Uses Symbol Table+DWARF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >9.2.01 Opening Debug Session</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="debug-session">Debug Session</h2>
<h3 id="implementation-goals">Implementation Goals</h3>
<p>The commands attach, exec, debug, core, and connect essentially all start a debugger backend and establish a connection between the debugger frontend and backend.</p>
<p>After establishing the connection, the debugger frontend needs to create a debug session where we can enter debug commands in the format <code>godbg&gt; COMMAND [flags] [args]</code> for debugging.</p>
<p>In Chapter 6 where we introduced instruction-level debugging, we already covered how to implement a debug session. Here, it&apos;s quite similar, especially after we significantly simplified go-delve/delve:</p>
<ul>
<li>Removed pagination output operations, although they are useful when outputting large amounts of data (like printing a variable with lots of data, bt printing a deep call stack, goroutines displaying all goroutine lists, etc.);</li>
<li>Removed starlark support, although the interactive repl way of executing starlark commands or source executing starlark scripts is cool and can further enhance debugger capabilities;</li>
<li>Removed syntax highlighting support, although it could improve readability when listing source code, printing stack traces with bt, or viewing type definitions with whatis;</li>
</ul>
<p>OK, you probably know why we removed these features - we want to maximize the simplification of our demo tinydbg. In fact, we introduce each of these features in the &quot;9.3 Advanced Feature Extensions&quot; chapter, but we don&apos;t want to keep the related code in tinydbg because the code is complex and readers might get lost in the code flood.</p>
<p>What are the differences between this simplified debug session and the debug session in Chapter 6? Mainly, it implements a frontend-backend separation architecture, where the frontend and backend communicate via JSON-RPC. When we execute a debug command in the debug session, the debug session parses the debug command, options, and arguments, then converts them into corresponding client method calls. The client&apos;s local method stub code converts these into interface method calls to the debugger backend, which then executes control over the tracee. We mainly focus on explaining the implementation details of this part.</p>
<h3 id="basic-knowledge">Basic Knowledge</h3>
<p>The diagram below shows the detailed interaction process and key processing logic during <code>godbg attach &lt;pid&gt;</code> starting a debugger backend and executing commands <code>godbg&gt; COMMAND [flags] [args]</code> in the debug session.</p>
<p><img alt="how debugsession works" src="assets/how_debugsession_works.png" width="720px"></p>
<p>This sequence diagram introduces two important steps during debugging:</p>
<ul>
<li>Part 1: Starting a debugger backend operation, which will be introduced when discussing the implementation of the attach operation, not covered in this section;</li>
<li>Part 2: Executing debug commands in the debug session, which is the key content we&apos;ll introduce in this section;</li>
</ul>
<p>Simply put, a debug session is an interactive debugging window that allows you to input debug commands and display debug results, repeating this process until debugging ends. By default, the debug session is an interactive command-line window that reads debug commands from stdin and outputs debug results to stdout and stderr. Unless you want to debug in a non-interactive way, like <code>tinydbg debug --allow-non-terminal-interactive</code> explicitly declaring non-interactive mode and setting correct IO redirection.</p>
<pre><code class="lang-bash">tinydbg <span class="hljs-built_in">help</span> debug
Compiles your program with optimizations disabled, starts and attaches to it.

By default, with no arguments, Delve will compile the <span class="hljs-string">&apos;main&apos;</span> package <span class="hljs-keyword">in</span> the
current directory, and begin to debug it. Alternatively you can specify a
package name and Delve will compile that package instead, and begin a new debug
session.

Usage:
  tinydbg debug [package] [flags]
...

Global Flags:
    --allow-non-terminal-interactive   Allows interactive sessions of Delve that don<span class="hljs-string">&apos;t have a terminal as stdin, stdout and stderr
-r, --redirect stringArray             Specifies redirect rules for target process (see &apos;</span>dlv <span class="hljs-built_in">help</span> redirect<span class="hljs-string">&apos;)
    ...
</span></code></pre>
<p>OK, let&apos;s introduce the main flow of debug session initialization and inputting debug commands for debugging.</p>
<h3 id="code-implementation">Code Implementation</h3>
<h4 id="debugger-frontend-initializes-debug-session">Debugger Frontend Initializes Debug Session</h4>
<p>When will a debug session be started?</p>
<ul>
<li>A debug session is always created during local debugging, whether executing attach, debug, exec, or core, where the debugger frontend and backend are in the same debugger process, communicating via net.Pipe;</li>
<li>During remote debugging, the debugger frontend and backend are separated, with the backend in a separate process without a control terminal. The debugger frontend connects to the debugger backend via the connect command, with frontend and backend communicating via net.TCPConn or net.UnixConn. The debugger frontend initializes a debug session for user interaction.</li>
</ul>
<p>If we&apos;re doing local debugging and executing the attach command, the code path for establishing the debug session is:</p>
<pre><code class="lang-bash">main.go:main.main
    \--&gt; cmds.New(<span class="hljs-literal">false</span>).Execute()
            \--&gt; attachCommand.Run()
                    \--&gt; attachCmd(...)
                            \--&gt; execute(pid, args, conf, <span class="hljs-string">&quot;&quot;</span>, debugger.ExecutingOther, args, buildFlags)
</code></pre>
<p>In the execute function, the RPC service layer is initialized differently based on whether it&apos;s local or remote debugging:</p>
<ul>
<li>Local debugging (no --headless): setup client/server communicate via preConnectedListener+net.Pipe</li>
<li>Remote debugging (with --headless): setup client/server communicate via net.TCPListener+net.TCPConn or net.UnixListener+net.UnixConn</li>
</ul>
<p>If executing the exec command, the code path for establishing the debug session is:</p>
<pre><code class="lang-bash">main.go:main.main
    \--&gt; cmds.New(<span class="hljs-literal">false</span>).Execute()
            \--&gt; <span class="hljs-built_in">exec</span>Command.Run()
                    \--&gt; execute(0, args, conf, <span class="hljs-string">&quot;&quot;</span>, debugger.ExecutingExistingFile, args, buildFlags)
</code></pre>
<p>If executing the debug command, the code path for establishing the debug session is:</p>
<pre><code class="lang-bash">main.go:main.main
    \--&gt; cmds.New(<span class="hljs-literal">false</span>).Execute()
            \--&gt; debugCommand.Run()
                    \--&gt; debugCmd(...)
                            \--&gt; execute(0, processArgs, conf, <span class="hljs-string">&quot;&quot;</span>, debugger.ExecutingGeneratedFile, dlvArgs, buildFlags)
</code></pre>
<p>If executing the core command, the code path for establishing the debug session is:</p>
<pre><code class="lang-bash">main.go:main.main
    \--&gt; cmds.New(<span class="hljs-literal">false</span>).Execute()
            \--&gt; coreCommand.Run()
                    \--&gt; coreCmd(...)
                            \--&gt; execute(0, []string{args[0]}, conf, args[1], debugger.ExecutingOther, args, buildFlags)
</code></pre>
<p>If we&apos;re explicitly doing remote debugging and executing the connect command, the code path for establishing the debug session is:</p>
<pre><code class="lang-bash">main.go:main.main
    \--&gt; cmds.New(<span class="hljs-literal">false</span>).Execute()
            \--&gt; connectCommand.Run()
                    \--&gt; connectCmd(...)
                            \--&gt; connect(addr, nil, conf)
</code></pre>
<p>This explains how the debugger frontend and backend connect. We also need to see how the debugger frontend outputs &quot;godbg&gt; &quot; and how it parses commands into local client method calls.</p>
<p>The execute method in local debugging and the connect method in remote debugging both involve initializing the debug session.</p>
<p>The execute method in local debugging ultimately calls the connect method, but with <code>listener.Addr().String()==&quot;&quot; &amp;&amp; clientConn != nil</code>, where the client uses clientConn to communicate with the server on the other end of net.Pipe. In remote mode, <code>listener.Addr().String() != &quot;&quot; &amp;&amp; clientConn == nil</code>, where the client creates a new connection using netDial(listener.Addr().String()) to communicate with the server. Finally, in connect, the debug session is established and run.</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> execute(attachPid <span class="hljs-keyword">int</span>, processArgs []<span class="hljs-keyword">string</span>, ...) <span class="hljs-keyword">int</span> {
    ...

    <span class="hljs-keyword">var</span> listener net.Listener
    <span class="hljs-keyword">var</span> clientConn net.Conn

    <span class="hljs-comment">// Make a TCP listener</span>
    <span class="hljs-keyword">if</span> headless {
        listener, _ = netListen(addr)
    } <span class="hljs-keyword">else</span> {
        listener, clientConn = service.ListenerPipe()
    }
    <span class="hljs-keyword">defer</span> listener.Close()

    ...

    <span class="hljs-keyword">return</span> connect(listener.Addr().String(), clientConn, conf)
}

<span class="hljs-comment">// If remote debugging mode, addr is valid and clientConn is nil, use net.Dial</span>
<span class="hljs-comment">// If local debugging mode, addr is invalid and clientConn is valid, use net.Pipe end clientConn directly</span>
<span class="hljs-keyword">func</span> connect(addr <span class="hljs-keyword">string</span>, clientConn net.Conn, conf *config.Config) <span class="hljs-keyword">int</span> {
    <span class="hljs-comment">// Create and start a terminal - attach to running instance</span>
    <span class="hljs-keyword">var</span> client *rpc2.RPCClient
    <span class="hljs-keyword">if</span> clientConn == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">if</span> clientConn = netDial(addr); clientConn == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-comment">// already logged</span>
        }
    }
    client = rpc2.NewClientFromConn(clientConn)
    ...

    <span class="hljs-comment">// Initialize debug session</span>
    session := debug.New(client, conf)
    session.InitFile = initFile
    status, err := session.Run()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(err)
    }
    <span class="hljs-keyword">return</span> status
}
</code></pre>
<p>We can see that at the end of connect, the debug session is created and run:</p>
<pre><code class="lang-go">session := debug.New(client, conf)
status, err := session.Run()
</code></pre>
<p>How does the debug session Run? Let&apos;s look at more details of session.Run().</p>
<h4 id="how-the-debug-session-runs">How the Debug Session Runs</h4>
<p>The <code>debug.(*Session).Run()</code> method is quite long but the logic is relatively clear:</p>
<ul>
<li>Record the list of functions defined in the target, convenient for later adding breakpoints at function locations, executing to functions, and creating tracepoints with automatic function name completion;</li>
<li>Record the debug commands and aliases supported by the current debugger, convenient for later command auto-completion when inputting commands, and auto-completing parameters when inputting command arguments<ul>
<li>If the input command is break, continue, trace, auto-complete function names</li>
<li>If the input command is nullcmd, nocmd, no special operation, reuse the last debug command;</li>
<li>If the input is print, whatis, auto-complete local variable names;</li>
</ul>
</li>
<li>Record the last executed command lastCmd;</li>
<li>Enter the debug session main loop, input debug commands, execute debug commands, focusing on executing debug commands <code>t.cmds.Call(cmdstr, t)</code>;</li>
</ul>
<p>Let&apos;s look at the debug session function:</p>
<pre><code class="lang-go"><span class="hljs-comment">// Run begins running the debugging session in the terminal.</span>
<span class="hljs-keyword">func</span> (t *Session) Run() (<span class="hljs-keyword">int</span>, error) {
    <span class="hljs-keyword">defer</span> t.Close()

    multiClient := t.client.IsMulticlient()

    <span class="hljs-comment">// Send the debugger a halt command on SIGINT</span>
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
    signal.Notify(ch, syscall.SIGINT)
    <span class="hljs-keyword">go</span> t.sigintGuard(ch, multiClient)

    <span class="hljs-comment">// Record which functions are defined in the target</span>
    fns := trie.New()
    <span class="hljs-comment">// Record which debug commands and command aliases are supported by the current debugger</span>
    cmds := trie.New()

    funcs, _ := t.client.ListFunctions(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">for</span> _, fn := <span class="hljs-keyword">range</span> funcs {
        fns.Add(fn, <span class="hljs-literal">nil</span>)
    }
    <span class="hljs-keyword">for</span> _, cmd := <span class="hljs-keyword">range</span> t.cmds.cmds {
        <span class="hljs-keyword">for</span> _, alias := <span class="hljs-keyword">range</span> cmd.aliases {
            cmds.Add(alias, <span class="hljs-literal">nil</span>)
        }
    }

    <span class="hljs-keyword">var</span> locs *trie.Trie

    <span class="hljs-comment">// Read current input, auto-complete command parameters based on input debug commands and incomplete command parameters</span>
    t.line.SetCompleter(<span class="hljs-keyword">func</span>(line <span class="hljs-keyword">string</span>) (c []<span class="hljs-keyword">string</span>) {
        cmd := t.cmds.Find(strings.Split(line, <span class="hljs-string">&quot; &quot;</span>)[<span class="hljs-number">0</span>], noPrefix)
        <span class="hljs-keyword">switch</span> cmd.aliases[<span class="hljs-number">0</span>] {
        <span class="hljs-comment">// For breakpoint-related operations, complete function names</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;break&quot;</span>, <span class="hljs-string">&quot;trace&quot;</span>, <span class="hljs-string">&quot;continue&quot;</span>:
            <span class="hljs-keyword">if</span> spc := strings.LastIndex(line, <span class="hljs-string">&quot; &quot;</span>); spc &gt; <span class="hljs-number">0</span> {
                prefix := line[:spc] + <span class="hljs-string">&quot; &quot;</span>
                funcs := fns.FuzzySearch(line[spc+<span class="hljs-number">1</span>:])
                <span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> funcs {
                    c = <span class="hljs-built_in">append</span>(c, prefix+f)
                }
            }
        <span class="hljs-comment">// If no command is entered</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;nullcmd&quot;</span>, <span class="hljs-string">&quot;nocmd&quot;</span>:
            commands := cmds.FuzzySearch(strings.ToLower(line))
            c = <span class="hljs-built_in">append</span>(c, commands...)
        <span class="hljs-comment">// If it&apos;s print or whatis, complete variable names</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;whatis&quot;</span>:
            <span class="hljs-keyword">if</span> locs == <span class="hljs-literal">nil</span> {
                localVars, err := t.client.ListLocalVariables(
                    api.EvalScope{GoroutineID: <span class="hljs-number">-1</span>, Frame: t.cmds.frame, DeferredCall: <span class="hljs-number">0</span>},
                    api.LoadConfig{},
                )
                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                    fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;Unable to get local variables: %s\n&quot;</span>, err)
                    <span class="hljs-keyword">break</span>
                }

                locs = trie.New()
                <span class="hljs-keyword">for</span> _, loc := <span class="hljs-keyword">range</span> localVars {
                    locs.Add(loc.Name, <span class="hljs-literal">nil</span>)
                }
            }

            <span class="hljs-keyword">if</span> spc := strings.LastIndex(line, <span class="hljs-string">&quot; &quot;</span>); spc &gt; <span class="hljs-number">0</span> {
                prefix := line[:spc] + <span class="hljs-string">&quot; &quot;</span>
                locals := locs.FuzzySearch(line[spc+<span class="hljs-number">1</span>:])
                <span class="hljs-keyword">for</span> _, l := <span class="hljs-keyword">range</span> locals {
                    c = <span class="hljs-built_in">append</span>(c, prefix+l)
                }
            }
        }
        <span class="hljs-keyword">return</span>
    })

    <span class="hljs-comment">// Read historical debug commands to quickly execute the previous command or repeat the last command via up/enter</span>
    fullHistoryFile, err := config.GetConfigFilePath(historyFile)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">&quot;Unable to load history file: %v.&quot;</span>, err)
    }

    t.historyFile, err = os.OpenFile(fullHistoryFile, os.O_RDWR|os.O_CREATE, <span class="hljs-number">0600</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">&quot;Unable to open history file: %v. History will not be saved for this session.&quot;</span>, err)
    }
    <span class="hljs-keyword">if</span> _, err := t.line.ReadHistory(t.historyFile); err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">&quot;Unable to read history file %s: %v\n&quot;</span>, fullHistoryFile, err)
    }

    fmt.Println(<span class="hljs-string">&quot;Type &apos;help&apos; for list of commands.&quot;</span>)

    <span class="hljs-keyword">if</span> t.InitFile != <span class="hljs-string">&quot;&quot;</span> {
        err := t.cmds.executeFile(t, t.InitFile)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">if</span> _, ok := err.(ExitRequestError); ok {
                <span class="hljs-keyword">return</span> t.handleExit()
            }
            fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;Error executing init file: %s\n&quot;</span>, err)
        }
    }

    <span class="hljs-comment">// Record the last executed command</span>
    <span class="hljs-keyword">var</span> lastCmd <span class="hljs-keyword">string</span>

    <span class="hljs-comment">// Ensure that the target process is neither running nor recording by</span>
    <span class="hljs-comment">// making a blocking call.</span>
    _, _ = t.client.GetState()

    <span class="hljs-comment">// Enter the main loop of the debugger</span>
    <span class="hljs-keyword">for</span> {
        locs = <span class="hljs-literal">nil</span>

        <span class="hljs-comment">// Read the user&apos;s input</span>
        cmdstr, _ := t.promptForInput()
        <span class="hljs-keyword">if</span> strings.TrimSpace(cmdstr) == <span class="hljs-string">&quot;&quot;</span> {
            cmdstr = lastCmd
        }

        <span class="hljs-comment">// Record the last executed command</span>
        lastCmd = cmdstr

        <span class="hljs-comment">// Execute the debugging command</span>
        <span class="hljs-keyword">if</span> err := t.cmds.Call(cmdstr, t); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">if</span> _, ok := err.(ExitRequestError); ok {
                <span class="hljs-keyword">return</span> t.handleExit()
            }
            ...
        }
    }
}
</code></pre>
<p>Let&apos;s look at <code>t.cmds.Call(cmdstr, t)</code>:</p>
<pre><code class="lang-go"><span class="hljs-comment">// Call takes a command to execute.</span>
<span class="hljs-keyword">func</span> (s *DebugCommands) Call(cmdstr <span class="hljs-keyword">string</span>, t *Session) error {
    ctx := callContext{Prefix: noPrefix, Scope: api.EvalScope{GoroutineID: <span class="hljs-number">-1</span>, Frame: s.frame, DeferredCall: <span class="hljs-number">0</span>}}
    <span class="hljs-keyword">return</span> s.CallWithContext(cmdstr, t, ctx)
}

<span class="hljs-comment">// callContext represents the context of a command.</span>
<span class="hljs-keyword">type</span> callContext <span class="hljs-keyword">struct</span> {
    Prefix     cmdPrefix
    Scope      api.EvalScope
    Breakpoint *api.Breakpoint
}


<span class="hljs-keyword">type</span> cmdfunc <span class="hljs-keyword">func</span>(t *Session, ctx callContext, args <span class="hljs-keyword">string</span>) error

<span class="hljs-keyword">type</span> command <span class="hljs-keyword">struct</span> {
    aliases         []<span class="hljs-keyword">string</span>
    builtinAliases  []<span class="hljs-keyword">string</span>
    group           commandGroup
    allowedPrefixes cmdPrefix
    helpMsg         <span class="hljs-keyword">string</span>
    cmdFn           cmdfunc
}

<span class="hljs-keyword">type</span> DebugCommands <span class="hljs-keyword">struct</span> {
    cmds   []*command
    client service.Client
    frame  <span class="hljs-keyword">int</span> <span class="hljs-comment">// Current frame as set by frame/up/down commands.</span>
}

<span class="hljs-comment">// CallWithContext takes a command and a context that command should be executed in.</span>
<span class="hljs-keyword">func</span> (s *DebugCommands) CallWithContext(cmdstr <span class="hljs-keyword">string</span>, t *Session, ctx callContext) error {
    vals := strings.SplitN(strings.TrimSpace(cmdstr), <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">2</span>)
    cmdname := vals[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> args <span class="hljs-keyword">string</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vals) &gt; <span class="hljs-number">1</span> {
        args = strings.TrimSpace(vals[<span class="hljs-number">1</span>])
    }
    <span class="hljs-keyword">return</span> s.Find(cmdname, ctx.Prefix).cmdFn(t, ctx, args)
}
</code></pre>
<p>DebugCommands is equivalent to managing debug commands in the debug session. The parameters needed for these debug commands are not as simple as attach, debug, exec, connect, and core. Each debug command needs very different parameters. The execution function <code>spf13/cobra.(*Command).Run(fset *flagsset, args []string)</code> in spf13/cobra, if still using the fixed parameters flagset and args, is not quite enough. Why do we say this? In Chapter 6 where we introduced instruction-level debugging, didn&apos;t we implement it completely based on the spf13/cobra Command management mechanism? We&apos;ll explain next.</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> command <span class="hljs-keyword">struct</span> {
    aliases         []<span class="hljs-keyword">string</span>
    builtinAliases  []<span class="hljs-keyword">string</span>
    group           commandGroup
    allowedPrefixes cmdPrefix
    helpMsg         <span class="hljs-keyword">string</span>
    cmdFn           cmdfunc
}
</code></pre>
<p>DebugCommands maintains all commands in the debug session:</p>
<ol>
<li>Built-in aliases and custom aliases for each command;</li>
<li>The group each command belongs to;           </li>
<li>The allowed cmdprefix for each command;</li>
<li>The help information for each command;</li>
<li>The execution function corresponding to each command;</li>
</ol>
<p>The command completion mechanism of spf13/cobra relies on generated shell completion files. spf13/cobra supports command grouping through the annotation mechanism and can customize help information, but each command&apos;s execution function still only has fixed <code>flagset *pflag.FlagSet</code> and <code>args []string</code>. If the function needs to use some JSON-RPC client or other things, it needs to be defined in the form of global variables. However, the form of reading and writing global variables everywhere is not good for readability and maintainability. We still hope the function signature can reflect the objects it depends on.</p>
<p>OK, so dlv here manages commands in the debug session in a custom way. When the corresponding debug command is found, it executes the corresponding <code>cmdFn()</code>. So the core of each debug command is the implementation logic in cmdFn, which often involves requests to the remote debugger backend (assembling request parameters, serializing data, network interaction, data display), and may involve multiple RPC requests, such as <code>print varNam&lt;tab&gt;</code> possibly involving <code>client.ListLocalVariables(...)</code>, <code>client.ExamineMemory(...)</code>, etc.</p>
<p>OK, let&apos;s first look at the JSON-RPC code logic here, and then look at a specific example.</p>
<h4 id="debugger-frontend-sends-json-rpc-requests-to-backend">Debugger Frontend Sends JSON-RPC Requests to Backend</h4>
<p>In this section, we&apos;ll focus on looking at the implementation of cmdFn for several representative debug commands.</p>
<pre><code class="lang-bash">t.cmds.Call(cmdstr, t)
    \--&gt; DebugCommands.CallWithContext(...)
            \--&gt; cmd:= s.Find(cmdname, ctx.Prefix)
                    \--&gt; cmd.cmdFn(t, ctx, args)
</code></pre>
<p>Let&apos;s see what methods the JSON-RPC client implements, and then select a few representative ones to introduce, no need to introduce them all here.</p>
<p>Let&apos;s take viewing the variable list in the current stack frame as an example. OK, when we execute <code>godbg&gt; vars [-v] [&lt;regex&gt;]</code>, it will execute <code>varsCmd.cmdFun(...) -&gt; vars(...)</code>.</p>
<p>See path-to/tinydbg/cmds/debug/def.go, first parse the input command line arguments, filter is a regular expression to filter the variable list. Then request t.client.ListPackageVariables(...) to initiate an RPC call, after getting the variable list returned by the server, print it out.</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> vars(t *Session, ctx callContext, args <span class="hljs-keyword">string</span>) error {
    <span class="hljs-comment">// Parse</span>
    filter, cfg := parseVarArguments(args, t)
    vars, err := t.client.ListPackageVariables(filter, cfg)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-keyword">return</span> t.printFilteredVariables(<span class="hljs-string">&quot;vars&quot;</span>, vars, filter, cfg)
}
</code></pre>
<p>See path-to/tinydbg/service/rpc2/client.go, this part is the logic for initiating JSON-RPC, calling the RPCServer.ListPackageVariables(...) method of the debugger backend, with the request body as args and the response as replay.</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> (c *RPCClient) ListPackageVariables(filter <span class="hljs-keyword">string</span>, cfg api.LoadConfig) ([]api.Variable, error) {
    <span class="hljs-keyword">var</span> out ListPackageVarsOut
    err := c.call(<span class="hljs-string">&quot;ListPackageVars&quot;</span>, ListPackageVarsIn{filter, cfg}, &amp;out)
    <span class="hljs-keyword">return</span> out.Variables, err
}

<span class="hljs-comment">// don&apos;t change this method name, it&apos;s used by main_test.go:TestTypecheckRPC</span>
<span class="hljs-keyword">func</span> (c *RPCClient) call(method <span class="hljs-keyword">string</span>, args, reply <span class="hljs-keyword">interface</span>{}) error {
    <span class="hljs-keyword">return</span> c.client.Call(<span class="hljs-string">&quot;RPCServer.&quot;</span>+method, args, reply)
}
</code></pre>
<p>All JSON-RPC request and response types are defined in <code>path-to/tinydbg/service/rpc2/*.go</code>. OK, next is the details of the JSON-RPC implementation in the Go standard library:</p>
<pre><code class="lang-bash">go/src/net/rpc.(*Client).Call(serverMethod, args, replay) error
    \--&gt; rpc.(*Client).Go(serviceMethod, args, reply, donechan) *Call {
            \--&gt; rpc.(*Client).send(call)
                    \--&gt; rpc.(*clientCodec).WriteRequest(request, call.Args)
                            \--&gt; rpc.(*Encoder).Encode(request)
                                            \--&gt; e.marshal(v, encOpts) as JSON data
                                            \--&gt; e.w.Write(jsondata), w==net.Conn
</code></pre>
<p>After sending, the debugger frontend waits for the debugger backend to receive the request, process it, and return the result. How does the JSON-RPC client read the result and return it?</p>
<p>Note the implementation of the JSON-RPC client.Call method. After <code>client.Go(serviceMethod, args, reply, ...)</code> executes, it returns a chan, which contains the RPC context information <code>*rpc.Call</code>. This call contains request, request-id, response, and error information. When the RPC execution ends, such as timeout, network error, or receiving a response packet, it will put this call back into this chan and close it, indicating that this request has been processed. At this time, <code>&lt;-client.Go(...).Done</code> will return the RPC context information, and this function ultimately returns whether there is an error.</p>
<pre><code class="lang-go"><span class="hljs-comment">// Call invokes the named function, waits for it to complete, and returns its error status.</span>
<span class="hljs-keyword">func</span> (client *Client) Call(serviceMethod <span class="hljs-keyword">string</span>, args any, reply any) error {
    call := &lt;-client.Go(serviceMethod, args, reply, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>)).Done
    <span class="hljs-keyword">return</span> call.Error
}
</code></pre>
<p>The function calls return level by level. When reaching the following function, it returns the variable list returned by the server:</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> (c *RPCClient) ListPackageVariables(filter <span class="hljs-keyword">string</span>, cfg api.LoadConfig) ([]api.Variable, error) {
    <span class="hljs-keyword">var</span> out ListPackageVarsOut
    err := c.call(<span class="hljs-string">&quot;ListPackageVars&quot;</span>, ListPackageVarsIn{filter, cfg}, &amp;out)
    <span class="hljs-keyword">return</span> out.Variables, err
}
</code></pre>
<p>Then, these variable lists can be printed out and displayed to the user:</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> vars(t *Session, ctx callContext, args <span class="hljs-keyword">string</span>) error {
    filter, cfg := parseVarArguments(args, t)
    vars, err := t.client.ListPackageVariables(filter, cfg)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-keyword">return</span> t.printFilteredVariables(<span class="hljs-string">&quot;vars&quot;</span>, vars, filter, cfg)
}
</code></pre>
<p>OK, what are the details of the underlying network packet reception? Similar to other network programming frameworks that support full-duplex communication with TCPConn and UnixConn, when designing the protocol, both requests and responses must contain request-id. The client side records a <code>map[request-id]*rpc.Call</code>. When receiving a response from the server connection, it extracts the request-id from the response body, then finds the original request body from the above map, and puts the response result back into the internal <code>*rpc.Call.Reply</code> of this RPC context.</p>
<p>See go/src/net/rpc/client.go</p>
<pre><code class="lang-go"><span class="hljs-comment">// Call represents an active RPC.</span>
<span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> {
    ServiceMethod <span class="hljs-keyword">string</span>     <span class="hljs-comment">// The name of the service and method to call.</span>
    Args          any        <span class="hljs-comment">// The argument to the function (*struct).</span>
    Reply         any        <span class="hljs-comment">// The reply from the function (*struct).</span>
    Error         error      <span class="hljs-comment">// After completion, the error status.</span>
    Done          <span class="hljs-keyword">chan</span> *Call <span class="hljs-comment">// Receives *Call when Go is complete.</span>
}
</code></pre>
<p>See go/src/net/rpc/client.go, the path for receiving response packets is like this:</p>
<pre><code class="lang-bash">go/src/net/rpc.(*Client).input()
    \--&gt; forloop
            \--&gt; client.codec.ReadResponseHeader(&amp;response)
            \--&gt; seq := response.Seq
            \--&gt; call := client.pending[seq]
                 delete(client.pending, seq)
            \--&gt; <span class="hljs-keyword">if</span> call == nil <span class="hljs-keyword">then</span> this request timeout and deleted already
            \--&gt; <span class="hljs-keyword">if</span> reponse.Error != <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">set</span> call.Error and <span class="hljs-keyword">done</span>
                    \--&gt; call.Done &lt;- call
            \--&gt; <span class="hljs-keyword">if</span> reponse.Error == nil <span class="hljs-keyword">then</span> <span class="hljs-built_in">set</span> call.Replay and <span class="hljs-keyword">done</span>
                    \--&gt; call.Done &lt;- call

go/src/net/rpc.(*Client).Call(serviceMethod string, args any, reply any) error
    \--&gt; call := &lt;-client.Go(serviceMethod, args, reply, make(chan *Call, 1)).Done
    \--&gt; <span class="hljs-built_in">return</span> call.Err

func (c *RPCClient) ListPackageVariables(filter string, cfg api.LoadConfig) ([]api.Variable, error)
    \--&gt; err := c.call(<span class="hljs-string">&quot;ListPackageVars&quot;</span>, ListPackageVarsIn{filter, cfg}, &amp;out)
    \--&gt; <span class="hljs-built_in">return</span> out.Variables, err
</code></pre>
<p>OK, that&apos;s roughly it. If you&apos;re interested in more details, you can look at the source code of this part yourself.</p>
<h4 id="debugger-backend-initializes-and-accepts-requests">Debugger Backend Initializes and Accepts Requests</h4>
<p>OK, next is the server side receiving packets and processing these requests. When we start in <code>--headless</code> mode, we start a debugger backend that runs as a service.</p>
<p>See path-to/tinydbg/cmds/root.go</p>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> execute(attachPid <span class="hljs-keyword">int</span>, processArgs []<span class="hljs-keyword">string</span>, conf *config.Config, coreFile <span class="hljs-keyword">string</span>, kind debugger.ExecuteKind, dlvArgs []<span class="hljs-keyword">string</span>, buildFlags <span class="hljs-keyword">string</span>) <span class="hljs-keyword">int</span> {
    ...
    <span class="hljs-comment">// Make a TCP listener or Unix listener, or preConnectedListener via net.Pipe</span>
    <span class="hljs-keyword">if</span> headless {
        listener, err = netListen(addr)
    } <span class="hljs-keyword">else</span> {
        listener, clientConn = service.ListenerPipe()
    }
    ...

    <span class="hljs-comment">// Create and start a debugger server</span>
    server := rpccommon.NewServer(&amp;service.Config{
        Listener:       listener,
        ProcessArgs:    processArgs,
        AcceptMulti:    acceptMulti,
        Debugger: debugger.Config{
            AttachPid:             attachPid,
            WorkingDir:            workingDir,
            CoreFile:              coreFile,
            Foreground:            headless &amp;&amp; tty == <span class="hljs-string">&quot;&quot;</span>,
            Packages:              dlvArgs,
            ...
        },
    })
    ...

    <span class="hljs-comment">// run the server</span>
    _ = server.Run()
    ...
</code></pre>
<p>So what does server.Run() do specifically?</p>
<pre><code class="lang-go"><span class="hljs-comment">// Run starts a debugger and exposes it with an JSON-RPC server. The debugger</span>
<span class="hljs-comment">// itself can be stopped with the `detach` API.</span>
<span class="hljs-keyword">func</span> (s *ServerImpl) Run() error {
    ...
    <span class="hljs-comment">// Create and start the debugger</span>
    config := s.config.Debugger
    <span class="hljs-keyword">if</span> s.debugger, err = debugger.New(&amp;config, s.config.ProcessArgs); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }

    <span class="hljs-comment">// Register the RPC methods mapping, map[methodName] = methodHandler</span>
    s.s2 = rpc2.NewServer(s.config, s.debugger)
    s.methodMap = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*methodType)
    registerMethods(s.s2, s.methodMap)

    <span class="hljs-comment">// Accept connection and serve the connection requests</span>
    <span class="hljs-keyword">go</span> <span class="hljs-keyword">func</span>() {
        <span class="hljs-keyword">defer</span> s.listener.Close()
        <span class="hljs-keyword">for</span> {
            c, err := s.listener.Accept()
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">select</span> {
                <span class="hljs-keyword">case</span> &lt;-s.stopChan:
                    <span class="hljs-comment">// We were supposed to exit, do nothing and return</span>
                    <span class="hljs-keyword">return</span>
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-built_in">panic</span>(err)
                }
            }

            <span class="hljs-comment">// serve the connection requests</span>
            <span class="hljs-keyword">go</span> s.serveConnection(c)
            <span class="hljs-keyword">if</span> !s.config.AcceptMulti {
                <span class="hljs-keyword">break</span>
            }
        }
    }()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-keyword">func</span> registerMethods(s *rpc2.RPCServer, methods <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*methodType) {
    methods[<span class="hljs-string">&quot;RPCServer.Command&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.Command)}
    methods[<span class="hljs-string">&quot;RPCServer.CreateBreakpoint&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.CreateBreakpoint)}
    methods[<span class="hljs-string">&quot;RPCServer.CreateWatchpoint&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.CreateWatchpoint)}
    methods[<span class="hljs-string">&quot;RPCServer.Detach&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.Detach)}
    methods[<span class="hljs-string">&quot;RPCServer.Disassemble&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.Disassemble)}
    methods[<span class="hljs-string">&quot;RPCServer.Eval&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.Eval)}
    methods[<span class="hljs-string">&quot;RPCServer.ExamineMemory&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.ExamineMemory)}
    ...
    methods[<span class="hljs-string">&quot;RPCServer.ListLocalVars&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.ListLocalVars)}
    methods[<span class="hljs-string">&quot;RPCServer.ListPackageVars&quot;</span>] = &amp;methodType{method: reflect.ValueOf(s.ListPackageVars)}
}
</code></pre>
<p>OK, let&apos;s see how to handle connection requests. The serializer here for JSON-RPC is of course the JSON decoder. Here it receives packets in a loop from the connection. After receiving a request packet, it takes out the handler <code>mtype</code> corresponding to request.Method. This handler is a method. Then according to the input parameter type and output parameter type of the method, it decodes the data in JSON into field values of specific types through reflection, and then calls the corresponding method for processing through reflection. After processing, it sends back the response.</p>
<p>It&apos;s worth mentioning that some of the server interfaces here are synchronous interfaces, and some are asynchronous interfaces:</p>
<ul>
<li>Synchronous interface, process one request at a time, response is written back to the frontend directly, and the current interface processing function returns;</li>
<li>Asynchronous interface, start a goroutine to process asynchronously when a request comes in, the interface processing logic returns early, and returns the result to the frontend through callback after processing;</li>
</ul>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> (s *ServerImpl) serveConnection(c io.ReadWriteCloser) {
    conn := &amp;bufReadWriteCloser{bufio.NewReader(c), c}
    s.log.Debugf(<span class="hljs-string">&quot;serving JSON-RPC on new connection&quot;</span>)
    <span class="hljs-keyword">go</span> s.serveJSONCodec(conn)
}

<span class="hljs-keyword">func</span> (s *ServerImpl) serveJSONCodec(conn io.ReadWriteCloser) {
    ...
    codec := jsonrpc.NewServerCodec(conn)
    <span class="hljs-keyword">var</span> req rpc.Request
    <span class="hljs-keyword">var</span> resp rpc.Response
    <span class="hljs-keyword">for</span> {
        req = rpc.Request{}
        err := codec.ReadRequestHeader(&amp;req)
        ...

        mtype, ok := s.methodMap[req.ServiceMethod]

        <span class="hljs-keyword">var</span> argv, replyv reflect.Value
        ...

        <span class="hljs-comment">// argv guaranteed to be a pointer now.</span>
        <span class="hljs-keyword">if</span> err = codec.ReadRequestBody(argv.Interface()); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span>
        }
        ...

        <span class="hljs-keyword">if</span> mtype.Synchronous {
            replyv = reflect.New(mtype.ReplyType.Elem())
            function := mtype.method
            returnValues := function.Call([]reflect.Value{argv, replyv})
            errInter := returnValues[<span class="hljs-number">0</span>].Interface()
            ...
            resp = rpc.Response{}
            s.sendResponse(sending, &amp;req, &amp;resp, replyv.Interface(), codec, errmsg)
            ...
        } <span class="hljs-keyword">else</span> {
            function := mtype.method
            ctl := &amp;RPCCallback{s, sending, codec, req, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}), clientDisconnectChan}
            <span class="hljs-keyword">go</span> <span class="hljs-keyword">func</span>() {
                ...
                function.Call([]reflect.Value{argv, reflect.ValueOf(ctl)})
            }()
            &lt;-ctl.setupDone
        }
    }
    ...
}
</code></pre>
<p>Let&apos;s take an asynchronous debug command disconnect as a reference, note its difference from vars:</p>
<pre><code class="lang-go"><span class="hljs-comment">// disconnectCmd</span>
<span class="hljs-keyword">func</span> (c *RPCClient) Disconnect(cont <span class="hljs-keyword">bool</span>) error {
    <span class="hljs-keyword">if</span> cont {
        out := <span class="hljs-built_in">new</span>(CommandOut)
        <span class="hljs-comment">// Asynchronously processed, does not wait for RPCServer.Command to finish executing before returning</span>
        c.client.Go(<span class="hljs-string">&quot;RPCServer.Command&quot;</span>, &amp;api.DebuggerCommand{Name: api.Continue, ReturnInfoLoadConfig: c.retValLoadCfg}, &amp;out, <span class="hljs-literal">nil</span>)
    }
    <span class="hljs-keyword">return</span> c.client.Close()
}

<span class="hljs-comment">// varsCmd</span>
<span class="hljs-keyword">func</span> (c *RPCClient) ListPackageVariables(filter <span class="hljs-keyword">string</span>, cfg api.LoadConfig) ([]api.Variable, error) {
    <span class="hljs-keyword">var</span> out ListPackageVarsOut
    <span class="hljs-comment">// call operation, returns only after receiving processing result</span>
    err := c.call(<span class="hljs-string">&quot;ListPackageVars&quot;</span>, ListPackageVarsIn{filter, cfg}, &amp;out)
    <span class="hljs-keyword">return</span> out.Variables, err
}
</code></pre>
<p>OK! That&apos;s all for the introduction.</p>
<h3 id="summary">Summary</h3>
<p>In this section, we have introduced the tinydbg debugger session in great detail. We introduced some features removed during the process of cutting down go-delve/delve to keep tinydbg as code-light as possible, making it easier for readers to learn. We introduced the entire interaction sequence during tinydbg starting the frontend and backend and working during the debug session, some key operations of the frontend and backend, and some key processing by the Linux kernel. Then, we introduced from typing a debugger command in the debugger session, how the debugger frontend parses and converts it into JSON-RPC to initiate calls to the debugger backend&apos;s RPC methods, the debugger backend&apos;s packet reception, processing, and returning results. We even introduced the working process of the standard library&apos;s JSON-RPC.</p>
<p>I believe readers have understood the specific working process of the debugger session. In the future, if we want to extend a new debug command, everyone should understand which parts of the project we need to adjust. OK, that&apos;s all for this section.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="00-cmds.html" class="navigation navigation-prev " aria-label="Previous page: 9.2.00 Core Debugging Commands">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="11-tinydbg_attach.html" class="navigation navigation-next " aria-label="Next page: 9.2.11 tinydbg attach">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"9.2.01 Opening Debug Session","level":"1.9.2.2","depth":3,"next":{"title":"9.2.11 tinydbg attach","level":"1.9.2.3","depth":3,"path":"9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/11-tinydbg_attach.md","ref":"9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/11-tinydbg_attach.md","articles":[]},"previous":{"title":"9.2.00 Core Debugging Commands","level":"1.9.2.1","depth":3,"path":"9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/00-cmds.md","ref":"9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/00-cmds.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["md-toc"],"pluginsConfig":{"intopic-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","visible":true,"label":{"en":"In This Article","zh":"æ¬æç®å½"}},"md-toc":{"label":"In this article","selector":".markdown-section h2","visible":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"9-develop-sym-debugger/2-æ ¸å¿è°è¯é»è¾/01-debug-session.md","mtime":"2025-06-15T12:38:02.486Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-06-15T13:13:32.255Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-md-toc/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-md-toc/gumshoe.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-md-toc/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

